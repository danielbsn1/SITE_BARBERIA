<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agenda - Barbearia TOP</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<header>Agenda - Barbearia TOP</header>
<main>
  <h2>Agenda</h2>

  <section>
    <label for="data">Escolha a data</label>
    <input type="date" id="data" />
  </section>

  <section>
    <h3>Novo Agendamento</h3>
    <form id="agendamentoForm">
      <label for="nome">Nome</label>
      <input id="nome" name="nome" required />

      <label for="telefone">Telefone</label>
      <input id="telefone" name="telefone" />

      <label for="servico">Serviço</label>
      <select id="servico" name="servico" required>
        <option></option>
      </select>

      <label for="hora">Hora</label>
      <select id="hora" name="hora" required>
        <!-- opções geradas por JS -->
      </select>

      <button type="submit">Agendar</button>
    </form>
    <div id="msg" class="error" style="display:none"></div>
  </section>

  <section>
    <h3>Agendamentos</h3>
    <ul id="lista-agendamentos">
      <li>Escolha uma data para ver agendamentos.</li>
    </ul>
  </section>
</main>

<script>
const hoje = new Date().toISOString().slice(0,10);
document.getElementById('data').value = hoje;

function gerarHoras(){
  const sel = document.getElementById('hora');
  sel.innerHTML = '';
  for(let h=8; h<=19; h++){ // 08:00 até 19:00
    const hh = String(h).padStart(2,'0') + ':00';
    const opt = document.createElement('option');
    opt.value = hh; opt.textContent = hh;
    sel.appendChild(opt);
  }
}

async function loadServicos(){
  try{
    const res = await fetch('/api/servicos');
    const data = await res.json();
    const sel = document.getElementById('servico');
    sel.innerHTML = '';
    if(!data.servicos || data.servicos.length===0){
      sel.innerHTML = '<option value="">Nenhum serviço</option>';
      return;
    }
    data.servicos.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.nome} — R$ ${Number(s.preco).toFixed(2)}`;
      sel.appendChild(opt);
    });
  }catch(err){
    console.error(err);
  }
}

async function loadAgendamentos(date){
  const ul = document.getElementById('lista-agendamentos');
  ul.innerHTML = '<li>Carregando...</li>';
  try{
    const res = await fetch('/api/agendamentos?data=' + date);
    if(!res.ok) throw new Error('Falha ao carregar');
    const data = await res.json();
    ul.innerHTML = '';
    if(!data.agendamentos || data.agendamentos.length===0){
      ul.innerHTML = '<li>Nenhum agendamento nesta data.</li>';
      return;
    }
    data.agendamentos.forEach(a=>{
      const li = document.createElement('li');
      const hora = a.data_hora ? a.data_hora.split(' ')[1] : '';
      li.textContent = `${hora} — ${a.cliente || a.nome || '---'} — ${a.servico || ''} — R$ ${Number(a.preco||0).toFixed(2)}`;
      ul.appendChild(li);
    });
  }catch(err){
    ul.innerHTML = `<li>Erro: ${err.message}</li>`;
  }
}

document.getElementById('data').addEventListener('change', (e)=> {
  loadAgendamentos(e.target);
});
</script>
</body>
</html>